name: CI/CD Deployment

on:
  push:
    branches: [ main ] # ä»…åœ¨ main åˆ†æ”¯æ›´æ–°æ—¶è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Verify Secrets
        run: |
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "âŒ ERROR: SERVER_IP secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "âŒ ERROR: SERVER_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ ERROR: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "âœ… All secrets are configured"
          echo "Server: ${{ secrets.SERVER_IP }}"
          echo "User: ${{ secrets.SERVER_USER }}"

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # æ˜¾ç¤ºå½“å‰ä¿¡æ¯
            echo "ğŸ“ å½“å‰ç”¨æˆ·: $(whoami)"
            echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
            echo "ğŸ“ Homeç›®å½•: $HOME"
            
            # 1. ç¡®å®šé¡¹ç›®ç›®å½•
            # å¦‚æœé¡¹ç›®åœ¨å…¶ä»–ä½ç½®ï¼Œè¯·ä¿®æ”¹è¿™ä¸ªå˜é‡
            PROJECT_DIR="${HOME}/Headache_trade-1"
            
            # æ£€æŸ¥é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR"
              echo "ğŸ“ æ­£åœ¨æœç´¢é¡¹ç›®..."
              # å°è¯•åœ¨å¸¸è§ä½ç½®æŸ¥æ‰¾
              if [ -d "$HOME/Headache_trade" ]; then
                PROJECT_DIR="$HOME/Headache_trade"
              elif [ -d "$HOME/crypto_deepseek" ]; then
                PROJECT_DIR="$HOME/crypto_deepseek"
              elif [ -d "/root/Headache_trade-1" ]; then
                PROJECT_DIR="/root/Headache_trade-1"
              elif [ -d "/root/Headache_trade" ]; then
                PROJECT_DIR="/root/Headache_trade"
              else
                echo "âŒ æœªæ‰¾åˆ°é¡¹ç›®ç›®å½•ï¼Œå¯ç”¨ç›®å½•:"
                ls -la $HOME/
                exit 1
              fi
            fi
            
            echo "âœ… æ‰¾åˆ°é¡¹ç›®ç›®å½•: $PROJECT_DIR"
            cd "$PROJECT_DIR" || exit 1
            
            # 2. è·å–ä»£ç æ›´æ–°
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            # å°è¯•æ‹‰å–ä»£ç ï¼Œå¦‚æœå¤±è´¥åˆ™å°è¯•ä¿®å¤ Remote URL
            if ! git pull origin main; then
                echo "âš ï¸ Git pull (HTTPS) å¤±è´¥ï¼Œå¯èƒ½æ˜¯è®¤è¯é—®é¢˜"
                echo "ğŸ”„ å°è¯•åˆ‡æ¢åˆ° SSH åè®®..."
                # è·å–å½“å‰çš„ remote url ä»¥å¤‡æ¢å¤
                OLD_URL=$(git remote get-url origin)
                
                # åˆ‡æ¢åˆ° SSH
                git remote set-url origin git@github.com:WilliamsMiao/Headache_trade.git
                
                if ! git pull origin main; then
                   echo "âŒ SSH æ‹‰å–ä¹Ÿå¤±è´¥äº†"
                   echo "ğŸ”„ æ¢å¤åŸæ¥çš„ URL: $OLD_URL"
                   git remote set-url origin "$OLD_URL"
                   
                   echo "======================================================="
                   echo "ğŸ”´  ä¸¥é‡é”™è¯¯:æœåŠ¡å™¨æ— æ³•ä» GitHub æ‹‰å–ä»£ç ï¼"
                   echo "-------------------------------------------------------"
                   echo "è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä»£ç æ²¡æœ‰æ›´æ–°ã€ä¾ç„¶æŠ¥é”™çš„åŸå› ã€‚"
                   echo "æœåŠ¡å™¨ä¸ä»…éœ€è¦è¿è¡Œä»£ç ï¼Œè¿˜éœ€è¦æœ‰æƒé™ä¸‹è½½ä»£ç ã€‚"
                   echo ""
                   echo "è¯·ç™»å½•æœåŠ¡å™¨æ‰§è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š"
                   echo "1. é…ç½® SSH Key (æ¨è):"
                   echo "   ç”Ÿæˆ key: ssh-keygen -t ed25519"
                   echo "   å°† ~/.ssh/id_ed25519.pub æ·»åŠ åˆ° GitHub ä»“åº“çš„ Deploy Keys"
                   echo ""
                   echo "2. æˆ–è€…æ‰‹åŠ¨è¾“å…¥ä¸€æ¬¡å¯†ç ä¿å­˜å‡­è¯:"
                   echo "   git config --global credential.helper store"
                   echo "   git pull origin main (è¾“å…¥ç”¨æˆ·å/ä»¤ç‰Œ)"
                   echo "======================================================="
                   exit 1
                else
                   echo "âœ… å·²æˆåŠŸåˆ‡æ¢åˆ° SSH åè®®å¹¶æ‹‰å–äº†ä»£ç "
                fi
            fi
            
            echo "ğŸ“‚ å½“å‰ç›®å½•ç»“æ„:"
            ls -F
            if [ -d "trading_bots" ]; then
                echo "ğŸ“‚ trading_bots ç›®å½•å†…å®¹:"
                ls -F trading_bots/
            else
                echo "âŒ è­¦å‘Š: trading_bots ç›®å½•ä¸å­˜åœ¨!"
            fi
            
            # 3. æ‰§è¡Œéƒ¨ç½²é€»è¾‘
            echo "ğŸ”§ æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            chmod +x deploy.sh run.sh restart_bot_safe.sh
            ./deploy.sh
            
            # 4. é‡å¯ç³»ç»Ÿï¼ˆä½¿ç”¨å®‰å…¨é‡å¯è„šæœ¬ï¼‰
            echo "ğŸ”„ é‡å¯äº¤æ˜“æœºå™¨äºº..."
            ./restart_bot_safe.sh
