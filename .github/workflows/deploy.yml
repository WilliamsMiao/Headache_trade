name: CI/CD Deployment

on:
  push:
    branches: [ main ] # ä»…åœ¨ main åˆ†æ”¯æ›´æ–°æ—¶è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Verify Secrets
        run: |
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "âŒ ERROR: SERVER_IP secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "âŒ ERROR: SERVER_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ ERROR: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "âœ… All secrets are configured"
          echo "Server: ${{ secrets.SERVER_IP }}"
          echo "User: ${{ secrets.SERVER_USER }}"

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 900s           # allow up to 15 min for pip/npm installs
          command_timeout: 600s   # stop if a single command hangs >10 min
          debug: true             # verbose logs to avoidâ€œå¡ä½â€æ— è¾“å‡º
          script: |
            set -euo pipefail

            # æ˜¾ç¤ºå½“å‰ä¿¡æ¯
            echo "ğŸ“ å½“å‰ç”¨æˆ·: $(whoami)"
            echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
            echo "ğŸ“ Homeç›®å½•: $HOME"
            
            # 1. ç¡®å®šé¡¹ç›®ç›®å½•
            # å¦‚æœé¡¹ç›®åœ¨å…¶ä»–ä½ç½®ï¼Œè¯·ä¿®æ”¹è¿™ä¸ªå˜é‡
            PROJECT_DIR="${HOME}/Headache_trade-1"
            
            # æ£€æŸ¥é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR"
              echo "ğŸ“ æ­£åœ¨æœç´¢é¡¹ç›®..."
              # å°è¯•åœ¨å¸¸è§ä½ç½®æŸ¥æ‰¾
              if [ -d "$HOME/Headache_trade" ]; then
                PROJECT_DIR="$HOME/Headache_trade"
              elif [ -d "$HOME/crypto_deepseek" ]; then
                PROJECT_DIR="$HOME/crypto_deepseek"
              elif [ -d "/root/Headache_trade-1" ]; then
                PROJECT_DIR="/root/Headache_trade-1"
              elif [ -d "/root/Headache_trade" ]; then
                PROJECT_DIR="/root/Headache_trade"
              else
                echo "âŒ æœªæ‰¾åˆ°é¡¹ç›®ç›®å½•ï¼Œå¯ç”¨ç›®å½•:"
                ls -la $HOME/
                exit 1
              fi
            fi
            
            echo "âœ… æ‰¾åˆ°é¡¹ç›®ç›®å½•: $PROJECT_DIR"
            cd "$PROJECT_DIR" || exit 1

            # é€šç”¨ sudo å‰ç¼€ï¼ˆroot åˆ™ä¸ºç©ºï¼‰
            SUDO=""
            if command -v sudo >/dev/null 2>&1; then
              if [ "$(id -u)" != "0" ]; then
                SUDO="sudo"
              fi
            fi

            echo "ğŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ– (git, python3-venv, pip, node, npm)..."
            if command -v apt-get >/dev/null 2>&1; then
              $SUDO apt-get update -y
              $SUDO apt-get install -y git python3 python3-venv python3-pip curl
              if ! command -v node >/dev/null 2>&1; then
                curl -fsSL https://deb.nodesource.com/setup_18.x | $SUDO -E bash -
                $SUDO apt-get install -y nodejs
              fi
            else
              echo "âš ï¸ é Debian/Ubuntu ç³»ç»Ÿï¼Œè¯·ç¡®ä¿å·²å®‰è£… node/npm ä¸ python3-venv"
            fi
            
            # 2. è·å–ä»£ç æ›´æ–°
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            
            # é…ç½® git ä»¥å¤„ç†å¼ºåˆ¶æ¨é€å¯¼è‡´çš„åˆ†æ­§åˆ†æ”¯
            git config pull.ff only 2>/dev/null || true
            
            # ä½¿ç”¨ fetch + reset æ–¹å¼è€Œä¸æ˜¯ pullï¼Œæ›´åŠ å¯é 
            # è¿™æ ·å¯ä»¥å¤„ç†å¼ºåˆ¶æ¨é€ï¼ˆgit push -fï¼‰å¯¼è‡´çš„åˆ†æ­§åˆ†æ”¯é—®é¢˜
            if ! git fetch origin main; then
                echo "âš ï¸ Git fetch (HTTPS) å¤±è´¥ï¼Œå¯èƒ½æ˜¯è®¤è¯é—®é¢˜"
                echo "ğŸ”„ å°è¯•åˆ‡æ¢åˆ° SSH åè®®..."
                # è·å–å½“å‰çš„ remote url ä»¥å¤‡æ¢å¤
                OLD_URL=$(git remote get-url origin)
                
                # åˆ‡æ¢åˆ° SSH
                git remote set-url origin git@github.com:WilliamsMiao/Headache_trade.git
                
                if ! git fetch origin main; then
                   echo "âŒ SSH fetch ä¹Ÿå¤±è´¥äº†"
                   echo "ğŸ”„ æ¢å¤åŸæ¥çš„ URL: $OLD_URL"
                   git remote set-url origin "$OLD_URL"
                   
                   echo "======================================================="
                   echo "ğŸ”´  ä¸¥é‡é”™è¯¯:æœåŠ¡å™¨æ— æ³•ä» GitHub æ‹‰å–ä»£ç ï¼"
                   echo "-------------------------------------------------------"
                   echo "è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä»£ç æ²¡æœ‰æ›´æ–°ã€ä¾ç„¶æŠ¥é”™çš„åŸå› ã€‚"
                   echo "æœåŠ¡å™¨ä¸ä»…éœ€è¦è¿è¡Œä»£ç ï¼Œè¿˜éœ€è¦æœ‰æƒé™ä¸‹è½½ä»£ç ã€‚"
                   echo ""
                   echo "è¯·ç™»å½•æœåŠ¡å™¨æ‰§è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š"
                   echo "1. é…ç½® SSH Key (æ¨è):"
                   echo "   ç”Ÿæˆ key: ssh-keygen -t ed25519"
                   echo "   å°† ~/.ssh/id_ed25519.pub æ·»åŠ åˆ° GitHub ä»“åº“çš„ Deploy Keys"
                   echo ""
                   echo "2. æˆ–è€…æ‰‹åŠ¨è¾“å…¥ä¸€æ¬¡å¯†ç ä¿å­˜å‡­è¯:"
                   echo "   git config --global credential.helper store"
                   echo "   git fetch origin main (è¾“å…¥ç”¨æˆ·å/ä»¤ç‰Œ)"
                   echo "======================================================="
                   exit 1
                else
                   echo "âœ… å·²æˆåŠŸåˆ‡æ¢åˆ° SSH åè®®å¹¶è·å–äº†ä»£ç "
                fi
            fi
            
            # ä½¿ç”¨ reset --hard æ¥åº”ç”¨è¿œç¨‹åˆ†æ”¯çš„æœ€æ–°çŠ¶æ€ï¼ˆå¤„ç†å¼ºåˆ¶æ¨é€ï¼‰
            echo "ğŸ”„ é‡ç½®æœ¬åœ°åˆ†æ”¯åˆ°è¿œç¨‹æœ€æ–°çŠ¶æ€..."
            git reset --hard origin/main
            echo "âœ… ä»£ç å·²åŒæ­¥åˆ°æœ€æ–°ç‰ˆæœ¬"
            
            echo "ğŸ“‚ å½“å‰ç›®å½•ç»“æ„:"
            ls -F
            if [ -d "trading_bots" ]; then
                echo "ğŸ“‚ trading_bots ç›®å½•å†…å®¹:"
                ls -F trading_bots/
            else
                echo "âŒ è­¦å‘Š: trading_bots ç›®å½•ä¸å­˜åœ¨!"
            fi
            
            # 3. æ‰§è¡Œéƒ¨ç½²é€»è¾‘
            echo "ğŸ”§ æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            
            # æ›´æ–° .env é…ç½®
            echo "ğŸ” æ›´æ–°ç¯å¢ƒé…ç½®..."
            if [ -n "${{ secrets.DEEPSEEK_API_KEY }}" ]; then
                echo "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}" > .env
                echo "OKX_API_KEY=${{ secrets.OKX_API_KEY }}" >> .env
                echo "OKX_SECRET=${{ secrets.OKX_SECRET }}" >> .env
                echo "OKX_PASSWORD=${{ secrets.OKX_PASSWORD }}" >> .env
                echo "âœ… .env é…ç½®å·²æ›´æ–°"
            else
                echo "âš ï¸ è­¦å‘Š: GitHub Secrets ä¸­æœªé…ç½® API å¯†é’¥ï¼Œè·³è¿‡ .env æ›´æ–°"
            fi
            
            chmod +x deploy.sh run.sh restart_bot_safe.sh start_services.sh
            
            # ç¡®ä¿æœ‰Node.jsç¯å¢ƒï¼ˆå‰ç«¯éœ€è¦ï¼‰
            if ! command -v node &> /dev/null; then
                echo "âš ï¸ Node.js æœªå®‰è£…ï¼Œè·³è¿‡å‰ç«¯éƒ¨ç½²"
            else
              echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ– (frontend_dashboard)..."
              cd "$PROJECT_DIR/frontend_dashboard"
              npm install --legacy-peer-deps
              cd "$PROJECT_DIR"
            fi
            
            # è¿è¡Œéƒ¨ç½²è„šæœ¬ï¼ˆå®‰è£…ä¾èµ–ï¼‰
            ./deploy.sh
            
            # 4. å¯åŠ¨å‰åç«¯æœåŠ¡
            echo "ğŸš€ å¯åŠ¨å‰åç«¯æœåŠ¡..."
            if [ -f "start_services.sh" ]; then
                ./start_services.sh
                echo "âœ… å‰åç«¯æœåŠ¡å·²å¯åŠ¨"
            else
                echo "âš ï¸ start_services.sh æœªæ‰¾åˆ°ï¼Œè·³è¿‡æœåŠ¡å¯åŠ¨"
            fi
            
            # 5. å¯é€‰ï¼šå¯åŠ¨äº¤æ˜“Botï¼ˆå¦‚æœéœ€è¦è‡ªåŠ¨äº¤æ˜“ï¼‰
            # å–æ¶ˆä¸‹é¢çš„æ³¨é‡Šä»¥å¯åŠ¨äº¤æ˜“Bot
            # echo "ğŸ¤– å¯åŠ¨äº¤æ˜“æœºå™¨äºº..."
            # ./run.sh &
