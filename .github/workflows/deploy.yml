name: CI/CD Deployment

on:
  push:
    branches: [ main ] # 仅在 main 分支更新时触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Verify Secrets
        run: |
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "❌ ERROR: SERVER_IP secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "❌ ERROR: SERVER_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "❌ ERROR: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "✅ All secrets are configured"
          echo "Server: ${{ secrets.SERVER_IP }}"
          echo "User: ${{ secrets.SERVER_USER }}"

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 显示当前信息
            echo "📍 当前用户: $(whoami)"
            echo "📍 当前目录: $(pwd)"
            echo "📍 Home目录: $HOME"
            
            # 1. 确定项目目录
            # 如果项目在其他位置，请修改这个变量
            PROJECT_DIR="${HOME}/Headache_trade-1"
            
            # 检查项目目录是否存在
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "❌ 项目目录不存在: $PROJECT_DIR"
              echo "📍 正在搜索项目..."
              # 尝试在常见位置查找
              if [ -d "$HOME/Headache_trade" ]; then
                PROJECT_DIR="$HOME/Headache_trade"
              elif [ -d "$HOME/crypto_deepseek" ]; then
                PROJECT_DIR="$HOME/crypto_deepseek"
              elif [ -d "/root/Headache_trade-1" ]; then
                PROJECT_DIR="/root/Headache_trade-1"
              elif [ -d "/root/Headache_trade" ]; then
                PROJECT_DIR="/root/Headache_trade"
              else
                echo "❌ 未找到项目目录，可用目录:"
                ls -la $HOME/
                exit 1
              fi
            fi
            
            echo "✅ 找到项目目录: $PROJECT_DIR"
            cd "$PROJECT_DIR" || exit 1
            
            # 2. 获取代码更新
            echo "📥 拉取最新代码..."
            
            # 配置 git 以处理强制推送导致的分歧分支
            git config pull.ff only 2>/dev/null || true
            
            # 使用 fetch + reset 方式而不是 pull，更加可靠
            # 这样可以处理强制推送（git push -f）导致的分歧分支问题
            if ! git fetch origin main; then
                echo "⚠️ Git fetch (HTTPS) 失败，可能是认证问题"
                echo "🔄 尝试切换到 SSH 协议..."
                # 获取当前的 remote url 以备恢复
                OLD_URL=$(git remote get-url origin)
                
                # 切换到 SSH
                git remote set-url origin git@github.com:WilliamsMiao/Headache_trade.git
                
                if ! git fetch origin main; then
                   echo "❌ SSH fetch 也失败了"
                   echo "🔄 恢复原来的 URL: $OLD_URL"
                   git remote set-url origin "$OLD_URL"
                   
                   echo "======================================================="
                   echo "🔴  严重错误:服务器无法从 GitHub 拉取代码！"
                   echo "-------------------------------------------------------"
                   echo "这就是为什么代码没有更新、依然报错的原因。"
                   echo "服务器不仅需要运行代码，还需要有权限下载代码。"
                   echo ""
                   echo "请登录服务器执行以下操作之一："
                   echo "1. 配置 SSH Key (推荐):"
                   echo "   生成 key: ssh-keygen -t ed25519"
                   echo "   将 ~/.ssh/id_ed25519.pub 添加到 GitHub 仓库的 Deploy Keys"
                   echo ""
                   echo "2. 或者手动输入一次密码保存凭证:"
                   echo "   git config --global credential.helper store"
                   echo "   git fetch origin main (输入用户名/令牌)"
                   echo "======================================================="
                   exit 1
                else
                   echo "✅ 已成功切换到 SSH 协议并获取了代码"
                fi
            fi
            
            # 使用 reset --hard 来应用远程分支的最新状态（处理强制推送）
            echo "🔄 重置本地分支到远程最新状态..."
            git reset --hard origin/main
            echo "✅ 代码已同步到最新版本"
            
            echo "📂 当前目录结构:"
            ls -F
            if [ -d "trading_bots" ]; then
                echo "📂 trading_bots 目录内容:"
                ls -F trading_bots/
            else
                echo "❌ 警告: trading_bots 目录不存在!"
            fi
            
            # 3. 执行部署逻辑
            echo "🔧 执行部署脚本..."
            
            # 更新 .env 配置
            echo "🔐 更新环境配置..."
            if [ -n "${{ secrets.DEEPSEEK_API_KEY }}" ]; then
                echo "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}" > .env
                echo "OKX_API_KEY=${{ secrets.OKX_API_KEY }}" >> .env
                echo "OKX_SECRET=${{ secrets.OKX_SECRET }}" >> .env
                echo "OKX_PASSWORD=${{ secrets.OKX_PASSWORD }}" >> .env
                echo "✅ .env 配置已更新"
            else
                echo "⚠️ 警告: GitHub Secrets 中未配置 API 密钥，跳过 .env 更新"
            fi
            
            chmod +x deploy.sh run.sh restart_bot_safe.sh start_services.sh
            
            # 确保有Node.js环境（前端需要）
            if ! command -v node &> /dev/null; then
                echo "⚠️ Node.js 未安装，跳过前端部署"
            fi
            
            # 运行部署脚本（安装依赖）
            ./deploy.sh
            
            # 4. 启动前后端服务
            echo "🚀 启动前后端服务..."
            if [ -f "start_services.sh" ]; then
                ./start_services.sh
                echo "✅ 前后端服务已启动"
            else
                echo "⚠️ start_services.sh 未找到，跳过服务启动"
            fi
            
            # 5. 可选：启动交易Bot（如果需要自动交易）
            # 取消下面的注释以启动交易Bot
            # echo "🤖 启动交易机器人..."
            # ./run.sh &
