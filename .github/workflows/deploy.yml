name: CI/CD Deployment

on:
  push:
    branches: [ main ] # ä»…åœ¨ main åˆ†æ”¯æ›´æ–°æ—¶è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Verify Secrets
        run: |
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "âŒ ERROR: SERVER_IP secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "âŒ ERROR: SERVER_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ ERROR: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "âœ… All secrets are configured"
          echo "Server: ${{ secrets.SERVER_IP }}"
          echo "User: ${{ secrets.SERVER_USER }}"

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          # å¦‚æœä½¿ç”¨å¯†é’¥è®¤è¯ï¼Œæ³¨é‡Šæ‰passwordï¼Œå¯ç”¨ä¸‹é¢çš„key
          # key: ${{ secrets.SSH_PRIVATE_KEY }}
          # passphrase: ${{ secrets.SSH_PASSPHRASE }}  # å¦‚æœç§é’¥æœ‰å¯†ç 
          script: |
            # æ˜¾ç¤ºå½“å‰ä¿¡æ¯
            echo "ğŸ“ å½“å‰ç”¨æˆ·: $(whoami)"
            echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
            echo "ğŸ“ Homeç›®å½•: $HOME"
            
            # 1. ç¡®å®šé¡¹ç›®ç›®å½•
            # å¦‚æœé¡¹ç›®åœ¨å…¶ä»–ä½ç½®ï¼Œè¯·ä¿®æ”¹è¿™ä¸ªå˜é‡
            PROJECT_DIR="${HOME}/Headache_trade-1"
            
            # æ£€æŸ¥é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR"
              echo "ğŸ“ æ­£åœ¨æœç´¢é¡¹ç›®..."
              # å°è¯•åœ¨å¸¸è§ä½ç½®æŸ¥æ‰¾
              if [ -d "$HOME/Headache_trade" ]; then
                PROJECT_DIR="$HOME/Headache_trade"
              elif [ -d "$HOME/crypto_deepseek" ]; then
                PROJECT_DIR="$HOME/crypto_deepseek"
              elif [ -d "/root/Headache_trade-1" ]; then
                PROJECT_DIR="/root/Headache_trade-1"
              elif [ -d "/root/Headache_trade" ]; then
                PROJECT_DIR="/root/Headache_trade"
              else
                echo "âŒ æœªæ‰¾åˆ°é¡¹ç›®ç›®å½•ï¼Œå¯ç”¨ç›®å½•:"
                ls -la $HOME/
                exit 1
              fi
            fi
            
            echo "âœ… æ‰¾åˆ°é¡¹ç›®ç›®å½•: $PROJECT_DIR"
            cd "$PROJECT_DIR" || exit 1
            
            # 2. è·å–ä»£ç æ›´æ–°
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main
            
            # 3. æ‰§è¡Œéƒ¨ç½²é€»è¾‘
            echo "ğŸ”§ æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            chmod +x deploy.sh run.sh restart_bot_safe.sh
            ./deploy.sh
            
            # 4. é‡å¯ç³»ç»Ÿï¼ˆä½¿ç”¨å®‰å…¨é‡å¯è„šæœ¬ï¼‰
            echo "ğŸ”„ é‡å¯äº¤æ˜“æœºå™¨äºº..."
            ./restart_bot_safe.sh
