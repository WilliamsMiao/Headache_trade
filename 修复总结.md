# Dashboard交易记录和盈亏计算修复总结

## 修复时间
2025-10-28 16:00-16:15

## 问题描述

1. **交易记录未显示**：Dashboard显示"暂无交易记录"
2. **盈亏计算错误**：显示-98.61%，明显不合理

## 根本原因

### 问题1：交易记录缺失
- `export_dashboard_data()` 函数未导出交易历史
- `get_recent_trades()` 使用了OKX不支持的`fetch_orders()`方法
- Dashboard API `/api/trades` 硬编码返回空数组

### 问题2：盈亏计算不准确
- 使用硬编码的初始值10000 USDT
- 实际余额只有139 USDT
- 没有正确计算持仓价值

## 修复内容

### 1. 交易历史获取功能（trading_bots/deepseek_trading_bot.py）

#### 新增函数：`get_recent_trades(limit=50)`
```python
def get_recent_trades(limit=50):
    """获取最近的交易历史"""
    # 使用fetch_my_trades替代不支持的fetch_orders
    trades = exchange.fetch_my_trades(TRADE_CONFIG['symbol'], limit=limit)
    # 格式化交易记录并返回
```

**修复点**：
- ✅ 使用OKX支持的`fetch_my_trades()`方法
- ✅ 返回完整的交易信息（时间、价格、数量、手续费等）
- ✅ 按时间倒序排列（最新的在前）

### 2. 盈亏计算逻辑修复

#### 新增函数：`get_or_set_initial_balance(current_balance)`
```python
def get_or_set_initial_balance(current_balance):
    """获取或设置初始资金"""
    # 从配置文件读取初始资金
    # 如果不存在，使用当前总资产作为初始值
```

#### 修改：`export_dashboard_data()` 函数
```python
# 正确计算总资产
total_value = usdt_balance
position_value = 0
if current_position:
    # 持仓价值 = 合约数量 * 合约乘数 * 当前价格
    position_value = current_position['size'] * contract_size * price
    total_value += position_value
    total_value += unrealized_pnl

# 动态获取初始资金
initial_value = get_or_set_initial_balance(total_value)

# 计算收益率
change_percent = ((total_value - initial_value) / initial_value) * 100
```

**修复点**：
- ✅ 新增`initial_balance.json`配置文件保存真实初始资金
- ✅ 正确计算持仓价值（合约数量 × 合约乘数 × 当前价格）
- ✅ 动态计算收益率，不再硬编码初始值

### 3. Dashboard API修复（trading_dashboard.py）

#### 修改：`/api/trades` 端点
```python
@app.route('/api/trades')
def get_trades():
    """获取交易历史 - 从dashboard_data.json读取"""
    data = load_dashboard_data_from_file()
    trades = data.get('trades', [])
    # 添加symbol字段供前端使用
    return jsonify(trades)
```

**修复点**：
- ✅ 从`dashboard_data.json`读取真实交易记录
- ✅ 为前端添加必要的symbol字段
- ✅ 不再返回硬编码的空数组

### 4. 数据导出增强

#### 修改：`export_dashboard_data()` 添加交易历史
```python
dashboard_data = {
    "account": {
        "balance": usdt_balance,
        "total_value": total_value,
        "change_percent": change_percent,
        "initial_balance": initial_value,  # 新增
        "position_value": position_value   # 新增
    },
    "trades": trade_history,  # 新增交易历史
    ...
}
```

## 修复结果

### ✅ 交易记录正常显示
```json
{
  "trades": [
    {
      "trade_id": "1858623429",
      "timestamp": "2025-10-28 16:09:31",
      "side": "buy",
      "amount": 0.05,
      "price": 114159.7,
      "cost": 57.08,
      "fee": 0.0285
    },
    {
      "trade_id": "1858619891",
      "timestamp": "2025-10-28 16:03:42",
      "side": "buy",
      "amount": 0.11,
      "price": 114152.4,
      "cost": 125.57,
      "fee": 0.0628
    }
  ]
}
```

### ✅ 盈亏计算正确
```json
{
  "account": {
    "balance": 120.59,          // 可用余额
    "position_value": 182.67,   // 持仓价值
    "total_value": 303.21,      // 总资产
    "initial_balance": 303.31,  // 初始资金
    "change_percent": -0.04     // 收益率：-0.04%
  }
}
```

**对比修复前后**：
- 修复前：change_percent = -98.61% ❌
- 修复后：change_percent = -0.04% ✅

## 新增文件

1. `/root/crypto_deepseek/data/initial_balance.json`
   ```json
   {
     "initial_balance": 303.314400255,
     "created_at": "2025-10-28 16:09:33"
   }
   ```

## 测试验证

### API测试
```bash
curl http://localhost:5001/api/trades
# 返回2条交易记录 ✅
```

### 日志验证
```
✅ Dashboard数据已导出: 2025-10-28 16:10:44
   - 总资产: 303.21 USDT
   - 收益率: -0.04%
   - 交易记录: 2 条
```

## 已重启的服务

1. ✅ 交易机器人（trading_bots/deepseek_trading_bot.py）
2. ✅ Dashboard（trading_dashboard.py）

## 验证步骤

访问 http://your-server-ip:5001 → 点击"交易"标签
- 应该能看到2条交易记录
- 显示正确的买入价格、数量、手续费
- 盈亏百分比应该显示-0.04%左右

## 后续建议

1. **初始资金重置**：如果需要重新设置初始资金，删除`/root/crypto_deepseek/data/initial_balance.json`文件，机器人会在下次运行时使用当前总资产作为新的初始值

2. **历史数据完整性**：当前只显示最近50笔交易，如需查看更多历史，可以修改`get_recent_trades(limit=50)`的limit参数

3. **性能优化**：如果交易记录很多，可以考虑在前端添加分页功能

